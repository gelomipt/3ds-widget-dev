<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3DX Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .widget-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .widget-header {
            border-bottom: 2px solid #0066cc;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .widget-header h1 {
            color: #0066cc;
            font-size: 24px;
        }
        
        .widget-content {
            padding: 10px 0;
        }
        
        .info-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #0066cc;
        }
        
        .info-section h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 12px;
            background: #4caf50;
            color: white;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .data-card {
            background: #fafafa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .data-card h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .data-card p {
            color: #666;
            font-size: 18px;
            font-weight: bold;
        }
        
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover {
            background: #0052a3;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        
        .log-timestamp {
            color: #858585;
        }
        
        .log-info {
            color: #4fc3f7;
        }
        
        .log-success {
            color: #66bb6a;
        }
        
        .log-error {
            color: #ef5350;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="widget-header">
            <h1>3DEXPERIENCE Widget</h1>
            <span class="status" id="status">Initializing...</span>
        </div>
        
        <div class="widget-content">
            <div class="info-section">
                <h3>Widget Information</h3>
                <p><strong>Environment:</strong> <span id="environment">Loading...</span></p>
                <p><strong>Widget ID:</strong> <span id="widgetId">N/A</span></p>
                <p><strong>User:</strong> <span id="userName">Not authenticated</span></p>
            </div>
            
            <div class="info-section">
                <h3>Actions</h3>
                <button onclick="testWidgetAPI()">Test Widget API</button>
                <button onclick="getPreferences()">Get Preferences</button>
                <button onclick="sendEvent()">Send Event</button>
                <button onclick="clearLog()">Clear Log</button>
            </div>
            
            <div class="data-grid">
                <div class="data-card">
                    <h4>API Calls</h4>
                    <p id="apiCalls">0</p>
                </div>
                <div class="data-card">
                    <h4>Events Received</h4>
                    <p id="eventsReceived">0</p>
                </div>
                <div class="data-card">
                    <h4>Last Update</h4>
                    <p id="lastUpdate">Never</p>
                </div>
            </div>
            
            <div class="log-area" id="logArea">
                <div class="log-entry log-info">
                    <span class="log-timestamp">[00:00:00]</span> Widget log initialized
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global counters
        let apiCallCount = 0;
        let eventCount = 0;
        
        // Logging function
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = timestamp;
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            log('Log cleared', 'info');
        }
        
        // Check if widget API is available
        function checkWidgetAPI() {
            if (typeof widget !== 'undefined') {
                log('✓ Widget API is available', 'success');
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('environment').textContent = '3DEXPERIENCE Platform';
                
                // Try to get widget ID
                try {
                    if (widget.id) {
                        document.getElementById('widgetId').textContent = widget.id;
                        log(`Widget ID: ${widget.id}`, 'info');
                    }
                } catch (e) {
                    log(`Could not get widget ID: ${e.message}`, 'error');
                }
                
                // Try to get user info
                try {
                    if (widget.user && widget.user.login) {
                        const userName = `${widget.user.firstname || ''} ${widget.user.lastname || ''} (${widget.user.login})`.trim();
                        document.getElementById('userName').textContent = userName;
                        log(`User: ${userName}`, 'success');
                    }
                } catch (e) {
                    log(`Could not get user info: ${e.message}`, 'error');
                }
                
                return true;
            } else {
                log('⚠ Widget API not available (running in standalone mode)', 'error');
                document.getElementById('status').textContent = 'Standalone';
                document.getElementById('environment').textContent = 'Browser (not in 3DX)';
                return false;
            }
        }
        
        // Test Widget API
        function testWidgetAPI() {
            apiCallCount++;
            document.getElementById('apiCalls').textContent = apiCallCount;
            
            if (typeof widget === 'undefined') {
                log('Widget API not available - running in standalone browser', 'error');
                return;
            }
            
            log('Testing Widget API...', 'info');
            
            try {
                // Test getValue
                log('Testing widget.getValue()...', 'info');
                const testValue = widget.getValue('testPreference');
                log(`getValue result: ${testValue || 'undefined'}`, 'success');
                
                // Test setValue
                log('Testing widget.setValue()...', 'info');
                widget.setValue('testPreference', 'Hello from widget at ' + new Date().toISOString());
                log('setValue executed successfully', 'success');
                
                // Test widget properties
                log('Widget properties:', 'info');
                log(`  - id: ${widget.id || 'N/A'}`, 'info');
                log(`  - title: ${widget.title || 'N/A'}`, 'info');
                
            } catch (e) {
                log(`Error testing Widget API: ${e.message}`, 'error');
            }
        }
        
        // Get preferences
        function getPreferences() {
            apiCallCount++;
            document.getElementById('apiCalls').textContent = apiCallCount;
            
            if (typeof widget === 'undefined') {
                log('Widget API not available', 'error');
                return;
            }
            
            log('Fetching preferences...', 'info');
            
            try {
                const prefs = ['testPreference', 'userConfig', 'widgetSettings'];
                prefs.forEach(pref => {
                    const value = widget.getValue(pref);
                    log(`${pref}: ${value || 'not set'}`, 'info');
                });
            } catch (e) {
                log(`Error getting preferences: ${e.message}`, 'error');
            }
        }
        
        // Send event
        function sendEvent() {
            eventCount++;
            document.getElementById('eventsReceived').textContent = eventCount;
            
            if (typeof widget === 'undefined') {
                log('Widget API not available', 'error');
                return;
            }
            
            log('Sending custom event...', 'info');
            
            try {
                // Example of publishing an event
                widget.publish('customEvent', {
                    message: 'Hello from widget',
                    timestamp: new Date().toISOString()
                });
                log('Event published successfully', 'success');
            } catch (e) {
                log(`Error sending event: ${e.message}`, 'error');
            }
        }
        
        // Initialize widget
        function initializeWidget() {
            log('Initializing widget...', 'info');
            
            const isInPlatform = checkWidgetAPI();
            
            if (isInPlatform) {
                // Set up event listeners if in platform
                try {
                    // Example: Listen for custom events
                    widget.addEvent('onLoad', function() {
                        log('Widget onLoad event triggered', 'success');
                    });
                    
                    widget.addEvent('onRefresh', function() {
                        log('Widget onRefresh event triggered', 'success');
                    });
                    
                    log('Event listeners registered', 'success');
                } catch (e) {
                    log(`Error setting up event listeners: ${e.message}`, 'error');
                }
            }
            
            log('Widget initialization complete', 'success');
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            log('DOM loaded', 'info');
            
            // Small delay to ensure widget API is available
            setTimeout(initializeWidget, 500);
        });
        
        // Handle errors
        window.addEventListener('error', function(e) {
            log(`Error: ${e.message}`, 'error');
        });
        
        // Log page info
        log(`Page loaded from: ${window.location.href}`, 'info');
        log(`User agent: ${navigator.userAgent.substring(0, 50)}...`, 'info');
    </script>
</body>
</html>
